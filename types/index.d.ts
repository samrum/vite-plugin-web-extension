import type { Plugin, ChunkMetadata, FilterPattern } from "vite";

type WebAccessibleDefinition =
  | {
      matches: string[];
      extensionIds?: string[];
      includeEntryFile?: boolean;
    }
  | {
      matches?: string[];
      extensionIds: string[];
      includeEntryFile?: boolean;
    };

type AdditionalInput =
  | string
  | {
      fileName: string;
      webAccessible: boolean | WebAccessibleDefinition;
    };

type NormalizedAdditionalInput = {
  fileName: string;
  webAccessible: WebAccessibleDefinition | null;
};

interface ViteWebExtensionOptions {
  /**
   * The manifest file to use as a base for the generated extension
   */
  manifest: chrome.runtime.Manifest;

  /**
   * In dev mode, apply Vite plugins to manifest HTML files by calling transformIndexHtml on them
   * Default: false
   */
  devHtmlTransform?: boolean;

  /**
   * Sets the use_dynamic_url property on web accessible resources generated by the plugin
   * Default: true
   */
  useDynamicUrlWebAccessibleResources?: boolean;

  /**
   * Additional input files that should be processed and treated as web extension inputs.
   * Useful for dynamically injected scripts and dynamically opened HTML pages.
   * The webAccessible option configures whether the input file and its depdendencies are included in the manifest `web_accessible_resources` property. Defaults to true.
   *  When set to `true`, defaults to:
        ```ts
          {
            matches: ['<all_urls>'],
            includeEntryFile: false,
          }
        ```
   *  The `includeEntryFile` option configures whether the entry file is included as a web accessible resource. Defaults to false.
   */
  additionalInputs?: {
    scripts?: AdditionalInput[];
    html?: AdditionalInput[];
    styles?: AdditionalInput[];
  };
}

/**
 * Build cross platform, module-based web extensions using vite
 */
export default function webExtension(options?: ViteWebExtensionOptions): Plugin;
